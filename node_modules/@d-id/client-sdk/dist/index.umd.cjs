(function(v,F){typeof exports=="object"&&typeof module<"u"?F(exports):typeof define=="function"&&define.amd?define(["exports"],F):(v=typeof globalThis<"u"?globalThis:v||self,F(v.index={}))})(this,function(v){"use strict";var F=(e=>(e.TRIAL="trial",e.BASIC="basic",e.ENTERPRISE="enterprise",e.LITE="lite",e.ADVANCED="advanced",e))(F||{}),Z=(e=>(e.TRIAL="deid-trial",e.PRO="deid-pro",e.ENTERPRISE="deid-enterprise",e.LITE="deid-lite",e.ADVANCED="deid-advanced",e.BUILD="deid-api-build",e.LAUNCH="deid-api-launch",e.SCALE="deid-api-scale",e))(Z||{}),G=(e=>(e.Created="created",e.Started="started",e.Done="done",e.Error="error",e.Rejected="rejected",e.Ready="ready",e))(G||{}),Q=(e=>(e.Unrated="Unrated",e.Positive="Positive",e.Negative="Negative",e))(Q||{}),b=(e=>(e.Functional="Functional",e.TextOnly="TextOnly",e.Maintenance="Maintenance",e.Playground="Playground",e.DirectPlayback="DirectPlayback",e))(b||{}),B=(e=>(e.Embed="embed",e.Query="query",e.Partial="partial",e.Answer="answer",e.Complete="done",e))(B||{}),ee=(e=>(e.KnowledgeProcessing="knowledge/processing",e.KnowledgeIndexing="knowledge/indexing",e.KnowledgeFailed="knowledge/error",e.KnowledgeDone="knowledge/done",e))(ee||{}),te=(e=>(e.Knowledge="knowledge",e.Document="document",e.Record="record",e))(te||{}),ne=(e=>(e.Pdf="pdf",e.Text="text",e.Html="html",e.Word="word",e.Json="json",e.Markdown="markdown",e.Csv="csv",e.Excel="excel",e.Powerpoint="powerpoint",e.Archive="archive",e.Image="image",e.Audio="audio",e.Video="video",e))(ne||{}),J=(e=>(e.Clip="clip",e.Talk="talk",e))(J||{});const re=e=>{switch(e){case"clip":return"clip";case"talk":return"talk";default:throw new Error(`Unknown video type: ${e}`)}};var j=(e=>(e.Start="START",e.Stop="STOP",e))(j||{}),K=(e=>(e.ChatAnswer="chat/answer",e.ChatPartial="chat/partial",e.StreamDone="stream/done",e.StreamStarted="stream/started",e.StreamFailed="stream/error",e.StreamReady="stream/ready",e.StreamCreated="stream/created",e.StreamVideoCreated="stream-video/started",e.StreamVideoDone="stream-video/done",e.StreamVideoError="stream-video/error",e.StreamVideoRejected="stream-video/rejected",e))(K||{}),D=(e=>(e.New="new",e.Fail="fail",e.Connected="connected",e.Connecting="connecting",e.Closed="closed",e.Completed="completed",e.Disconnected="disconnected",e))(D||{}),ae=(e=>(e.Amazon="amazon",e.Microsoft="microsoft",e.Afflorithmics="afflorithmics",e.Elevenlabs="elevenlabs",e))(ae||{}),ie=(e=>(e.Public="public",e.Premium="premium",e.Private="private",e))(ie||{});const W="https://api.d-id.com",ye="wss://notifications.d-id.com",pe="79f81a83a67430be2bc0fd61042b8faa";async function se(e,t){const s={limit:(t==null?void 0:t.limit)??3,delayMs:(t==null?void 0:t.delayMs)??0,timeout:(t==null?void 0:t.timeout)??3e4,timeoutErrorMessage:(t==null?void 0:t.timeoutErrorMessage)||"Timeout error",shouldRetryFn:(t==null?void 0:t.shouldRetryFn)??function(){return!0}};let a;for(let n=1;n<=s.limit;n++)try{if(!s.timeout)return await e();let i;const r=new Promise((l,h)=>{e().then(d=>{clearTimeout(i),l(d)}).catch(d=>{clearTimeout(i),h(d)})}),o=new Promise((l,h)=>{i=setTimeout(()=>h(new Error(s.timeoutErrorMessage)),s.timeout)});return await Promise.race([r,o])}catch(i){if(a=i,!s.shouldRetryFn(i)||n>=s.limit)throw i;s.delayMs>0&&await new Promise(r=>setTimeout(r,s.delayMs))}throw a}const x=()=>Math.random().toString(16).slice(2);function oe(){let e=window.localStorage.getItem("did_external_key_id");return e||(e=Math.random().toString(16).slice(2),window.localStorage.setItem("did_external_key_id",e)),e}let ve=x();function ce(e){if(e.type==="bearer")return`Bearer ${e.token}`;if(e.type==="basic")return`Basic ${btoa(`${e.username}:${e.password}`)}`;if(e.type==="key")return`Client-Key ${e.clientKey}.${oe()}_${ve}`;throw new Error(`Unknown auth type: ${e}`)}const ke=e=>se(e,{limit:3,delayMs:1e3,timeout:0,shouldRetryFn:t=>t.status===429});function O(e,t=W,s){const a=async(n,i)=>{const{skipErrorHandler:r,...o}=i||{},m=await ke(()=>fetch(t+(n!=null&&n.startsWith("/")?n:`/${n}`),{...o,headers:{...o.headers,Authorization:ce(e),"Content-Type":"application/json"}}));if(!m.ok){let l=await m.text().catch(()=>"Failed to fetch");throw s&&!r&&s(new Error(l),{url:n,options:o,headers:m.headers}),new Error(l)}return m.json()};return{get(n,i){return a(n,{...i,method:"GET"})},post(n,i,r){return a(n,{...r,body:JSON.stringify(i),method:"POST"})},delete(n,i,r){return a(n,{...r,body:JSON.stringify(i),method:"DELETE"})},patch(n,i,r){return a(n,{...r,body:JSON.stringify(i),method:"PATCH"})}}}function de(e,t=W,s){const a=O(e,`${t}/agents`,s);return{create(n,i){return a.post("/",n,i)},getAgents(n,i){return a.get(`/${n?`?tag=${n}`:""}`,i).then(r=>r??[])},getById(n,i){return a.get(`/${n}`,i)},delete(n,i){return a.delete(`/${n}`,void 0,i)},update(n,i,r){return a.patch(`/${n}`,i,r)},newChat(n,i,r){return a.post(`/${n}/chat`,i,r)},chat(n,i,r,o){return a.post(`/${n}/chat/${i}`,r,o)},createRating(n,i,r,o){return a.post(`/${n}/chat/${i}/ratings`,r,o)},updateRating(n,i,r,o,m){return a.patch(`/${n}/chat/${i}/ratings/${r}`,o,m)},deleteRating(n,i,r,o){return a.delete(`/${n}/chat/${i}/ratings/${r}`,o)},getSTTToken(n,i){return a.get(`/${n}/stt-token`,i)}}}const Ce=e=>new Promise(t=>setTimeout(t,e));function Re(e){return new Promise((t,s)=>{const{callbacks:a,host:n,auth:i}=e,{onMessage:r=null,onOpen:o=null,onClose:m=null,onError:l=null}=a||{},h=new WebSocket(`${n}?authorization=${ce(i)}`);h.onmessage=r,h.onclose=m,h.onerror=d=>{console.error(d),l==null||l("Websocket failed to connect",d),s(d)},h.onopen=d=>{o==null||o(d),t(h)}})}async function Se(e){const{retries:t=1}=e;let s=null;for(let a=0;(s==null?void 0:s.readyState)!==WebSocket.OPEN;a++)try{s=await Re(e)}catch(n){if(a===t)throw n;await Ce(a*500)}return s}async function De(e,t,s){const a=s!=null&&s.onMessage?[s.onMessage]:[],n=await Se({auth:e,host:t,callbacks:{onError:s==null?void 0:s.onError,onMessage:i=>{const r=JSON.parse(i.data);a.forEach(o=>o(r.event,r))}}});return{socket:n,disconnect:()=>n.close(),subscribeToEvents:i=>a.push(i)}}const Me="X-Playground-Chat";function _e(e,t,s,a){const n=O(e,`${t}/agents/${s}`,a);return{createStream(i){return n.post("/streams",{output_resolution:i.output_resolution,compatibility_mode:i.compatibility_mode,stream_warmup:i.stream_warmup,session_timeout:i.session_timeout,stream_greeting:i.stream_greeting})},startConnection(i,r,o){return n.post(`/streams/${i}/sdp`,{session_id:o,answer:r})},addIceCandidate(i,r,o){return n.post(`/streams/${i}/ice`,{session_id:o,...r})},sendStreamRequest(i,r,o){return n.post(`/streams/${i}`,{session_id:r,...o})},close(i,r){return n.delete(`/streams/${i}`,{session_id:r})}}}function be(e,t,s,a){const n=O(e,`${t}/agents/${s}`,a);return{createStream(i,r){return n.post("/streams",{driver_url:i.driver_url,face:i.face,config:i.config,output_resolution:i.output_resolution,compatibility_mode:i.compatibility_mode,stream_warmup:i.stream_warmup,session_timeout:i.session_timeout,stream_greeting:i.stream_greeting},r)},startConnection(i,r,o,m){return n.post(`/streams/${i}/sdp`,{session_id:o,answer:r},m)},addIceCandidate(i,r,o,m){return n.post(`/streams/${i}/ice`,{session_id:o,...r},m)},sendStreamRequest(i,r,o,m){return n.post(`/streams/${i}`,{session_id:r,...o},m)},close(i,r,o){return n.delete(`/streams/${i}`,{session_id:r},o)}}}function Ee(e,t,s){const a=(t.timestamp-e.timestamp)/1e3;return{duration:a,bytesReceived:t.bytesReceived-e.bytesReceived,bitrate:Math.round((t.bytesReceived-e.bytesReceived)*8/a),packetsReceived:t.packetsReceived-e.packetsReceived,packetsLost:t.packetsLost-e.packetsLost,framesDropped:t.framesDropped-e.framesDropped,framesDecoded:t.framesDecoded-e.framesDecoded,jitter:t.jitter,jitterBufferDelay:(t.jitterBufferDelay-e.jitterBufferDelay)/a,framesPerSecond:t.framesPerSecond,freezeCount:t.freezeCount-e.freezeCount,freezeDuration:t.freezeDuration-e.freezeDuration,lowFpsCount:s}}function Pe(e){return e.filter(t=>t.freezeCount>0||t.framesPerSecond<21||t.framesDropped>0||t.packetsLost>0).map(t=>{const{timestamp:s,...a}=t,n=[];return t.freezeCount>0&&n.push("freeze"),t.framesPerSecond<21&&n.push("low fps"),t.framesDropped>0&&n.push("frames dropped"),t.packetsLost>0&&n.push("packet loss"),{...a,causes:n}})}function Ie(e){let t="";for(const s of e.values())if(s&&s.type==="codec"&&s.mimeType.startsWith("video")&&(t=s.mimeType.split("/")[1]),s&&s.type==="inbound-rtp"&&s.kind==="video")return{codec:t,timestamp:s.timestamp,bytesReceived:s.bytesReceived,packetsReceived:s.packetsReceived,packetsLost:s.packetsLost,framesDropped:s.framesDropped,framesDecoded:s.framesDecoded,jitter:s.jitter,jitterBufferDelay:s.jitterBufferDelay,frameWidth:s.frameWidth,frameHeight:s.frameHeight,framesPerSecond:s.framesPerSecond,freezeCount:s.freezeCount,freezeDuration:s.totalFreezesDuration};return{}}function Te(e,t,s){const a=e.map((r,o)=>o===0?s?{timestamp:r.timestamp,duration:0,bytesReceived:r.bytesReceived-s.bytesReceived,bitrate:(r.bytesReceived-s.bytesReceived)*8/(t/1e3),packetsReceived:r.packetsReceived-s.packetsReceived,packetsLost:r.packetsLost-s.packetsLost,framesDropped:r.framesDropped-s.framesDropped,framesDecoded:r.framesDecoded-s.framesDecoded,jitter:r.jitter,jitterBufferDelay:r.jitterBufferDelay-s.jitterBufferDelay,framesPerSecond:r.framesPerSecond,freezeCount:r.freezeCount-s.freezeCount,freezeDuration:r.freezeDuration-s.freezeDuration}:{timestamp:r.timestamp,duration:0,bytesReceived:r.bytesReceived,bitrate:r.bytesReceived*8/(t/1e3),packetsReceived:r.packetsReceived,packetsLost:r.packetsLost,framesDropped:r.framesDropped,framesDecoded:r.framesDecoded,jitter:r.jitter,jitterBufferDelay:r.jitterBufferDelay,framesPerSecond:r.framesPerSecond,freezeCount:r.freezeCount,freezeDuration:r.freezeDuration}:{timestamp:r.timestamp,duration:t*o/1e3,bytesReceived:r.bytesReceived-e[o-1].bytesReceived,bitrate:(r.bytesReceived-e[o-1].bytesReceived)*8/(t/1e3),packetsReceived:r.packetsReceived-e[o-1].packetsReceived,packetsLost:r.packetsLost-e[o-1].packetsLost,framesDropped:r.framesDropped-e[o-1].framesDropped,framesDecoded:r.framesDecoded-e[o-1].framesDecoded,jitter:r.jitter,jitterBufferDelay:r.jitterBufferDelay-e[o-1].jitterBufferDelay,framesPerSecond:r.framesPerSecond,freezeCount:r.freezeCount-e[o-1].freezeCount,freezeDuration:r.freezeDuration-e[o-1].freezeDuration}),n=Pe(a),i=n.reduce((r,o)=>r+(o.causes.includes("low fps")?1:0),0);return{webRTCStats:{anomalies:n,aggregateReport:Ee(e[0],e[e.length-1],i)},codec:e[0].codec,resolution:`${e[0].frameWidth}x${e[0].frameHeight}`}}let le=!1;const z=(e,t)=>le&&console.log(e,t),Ae=(window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection).bind(window);function me(e){switch(e){case"connected":return D.Connected;case"checking":return D.Connecting;case"failed":return D.Fail;case"new":return D.New;case"closed":return D.Closed;case"disconnected":return D.Disconnected;case"completed":return D.Completed;default:return D.New}}function $e(){let e=0;return t=>{for(const s of t.values())if(s&&s.type==="inbound-rtp"&&s.kind==="video"){const a=s.bytesReceived,n=a-e>0;return e=a,n}return!1}}function je(e,t,s=!1,a,n,i=!1){const o=Math.max(Math.ceil(10),1);let m=[],l,h=0,d=!1;const C=s?1:0;let p=0;const R=$e();return setInterval(async()=>{const w=await e.getStats(),f=R(w),E=Ie(w);if(f)h=0,d||(t==null||t(j.Start),i&&p>=C&&!a()&&n(),l=m[m.length-1],m=[],p++,d=!0),m.push(E);else if(d&&(h++,h>=o)){const S=Te(m,100,l);t==null||t(j.Stop,S),!i&&!a()&&n(),d=!1}},100)}async function ze(e,t,{debug:s=!1,callbacks:a,auth:n,baseURL:i=W,warmup:r}){le=s;const{startConnection:o,sendStreamRequest:m,close:l,createStream:h,addIceCandidate:d}=t.videoType===J.Clip?_e(n,i,e,a.onError):be(n,i,e,a.onError),{id:C,offer:p,ice_servers:R,session_id:w}=await h(t),f=new Ae({iceServers:R}),E=f.createDataChannel("JanusDataChannel");if(!w)throw new Error("Could not create session_id");let S=!1;const c=()=>S,g=()=>{var u;S=!0,(u=a.onConnectionStateChange)==null||u.call(a,D.Connected)},k=je(f,a.onVideoStateChange,r,c,g,!!t.stream_greeting);f.onicecandidate=u=>{var y;z("peerConnection.onicecandidate",u);try{u.candidate&&u.candidate.sdpMid&&u.candidate.sdpMLineIndex!==null?d(C,{candidate:u.candidate.candidate,sdpMid:u.candidate.sdpMid,sdpMLineIndex:u.candidate.sdpMLineIndex},w):d(C,{candidate:null},w)}catch(_){(y=a.onError)==null||y.call(a,_,{streamId:C})}},E.onopen=()=>{!t.stream_warmup&&!t.stream_greeting&&g()},f.oniceconnectionstatechange=()=>{var y;z("peerConnection.oniceconnectionstatechange => "+f.iceConnectionState);const u=me(f.iceConnectionState);u!==D.Connected&&((y=a.onConnectionStateChange)==null||y.call(a,u))},f.ontrack=u=>{var y;z("peerConnection.ontrack",u),(y=a.onSrcObjectReady)==null||y.call(a,u.streams[0])},await f.setRemoteDescription(p),z("set remote description OK");const M=await f.createAnswer();return z("create answer OK"),await f.setLocalDescription(M),z("set local description OK"),await o(C,M,w),z("start connection OK"),{speak(u){return m(C,w,u)},async disconnect(){var u,y;if(C){const _=me(f.iceConnectionState);if(f){if(_===D.New){(u=a.onVideoStateChange)==null||u.call(a,j.Stop),clearInterval(k);return}f.close(),f.oniceconnectionstatechange=null,f.onnegotiationneeded=null,f.onicecandidate=null,f.ontrack=null}try{_===D.Connected&&await l(C,w).catch(P=>{})}catch(P){z("Error on close stream connection",P)}(y=a.onVideoStateChange)==null||y.call(a,j.Stop),clearInterval(k)}},sessionId:w,streamId:C}}const X=e=>e.type==="clip"&&e.presenter_id.startsWith("v2_")?"clip_v2":e.type;let Y={};function Le(e){var i,r,o,m,l,h;const t=window!=null&&window.hasOwnProperty("DID_AGENTS_API")?"agents-ui":"agents-sdk",s=e.agent.presenter,a=(i=e.agent.llm)==null?void 0:i.prompt_customization,n={token:e.token||"testKey",distinct_id:e.distinctId||oe(),agentId:e.agent.id,agentType:X(s),owner_id:e.agent.owner_id??"",promptVersion:(r=e.agent.llm)==null?void 0:r.prompt_version,behavior:{role:a==null?void 0:a.role,personality:a==null?void 0:a.personality,instructions:(o=e.agent.llm)==null?void 0:o.instructions},temperature:(m=e.agent.llm)==null?void 0:m.temperature,knowledgeSource:a==null?void 0:a.knowledge_source,starterQuestionsCount:(h=(l=e.agent.knowledge)==null?void 0:l.starter_message)==null?void 0:h.length,topicsToAvoid:a==null?void 0:a.topics_to_avoid,maxResponseLength:a==null?void 0:a.max_response_length};return{...n,additionalProperties:{},isEnabled:e.isEnabled??!0,getRandom:()=>Math.random().toString(16).slice(2),enrich(d){const C={};if(d&&typeof d!="object")throw new Error("properties must be a flat json object");for(let p in d)(typeof d[p]=="string"||typeof d[p]=="number")&&(C[p]=d[p]);this.additionalProperties={...this.additionalProperties,...C}},track(d,C){if(!this.isEnabled)return Promise.resolve();const{audioPath:p,...R}=C||{},w={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({data:JSON.stringify([{event:d,properties:{...this.additionalProperties,...R,...n,source:t,time:Date.now(),$insert_id:this.getRandom(),origin:window.location.href,"Screen Height":window.screen.height||window.innerWidth,"Screen Width":window.screen.width||window.innerHeight,"User Agent":navigator.userAgent}}])})};return fetch("https://api-js.mixpanel.com/track/?verbose=1&ip=1",w).then(f=>f.json()).catch(f=>console.error(f))},linkTrack(d,C,p,R){Y[d]||(Y[d]={events:{},resolvedDependencies:[]}),R.includes(p)||R.push(p);const w=Y[d];if(w.events[p]={props:C},w.resolvedDependencies.push(p),R.every(E=>w.resolvedDependencies.includes(E))){const E=R.reduce((S,c)=>w.events[c]?{...S,...w.events[c].props}:S,{});this.track(d,E),w.resolvedDependencies=w.resolvedDependencies.filter(S=>!R.includes(S)),R.forEach(S=>{delete w.events[S]})}}}}function Ne(e){var n,i,r,o;const t=()=>/Mobi|Android/i.test(navigator.userAgent)?"Mobile":"Desktop",s=()=>{const m=navigator.platform;return m.toLowerCase().includes("win")?"Windows":m.toLowerCase().includes("mac")?"Mac OS X":m.toLowerCase().includes("linux")?"Linux":"Unknown"},a=e.presenter;return{$os:`${s()}`,isMobile:`${t()=="Mobile"}`,browser:navigator.userAgent,origin:window.location.origin,agentType:X(a),agentVoice:{voiceId:(i=(n=e.presenter)==null?void 0:n.voice)==null?void 0:i.voice_id,provider:(o=(r=e.presenter)==null?void 0:r.voice)==null?void 0:o.type}}}function Be(e,t,s){var l,h;const{event:a,...n}=e,{template:i}=(t==null?void 0:t.llm)||{},{language:r}=((l=t==null?void 0:t.presenter)==null?void 0:l.voice)||{},{stitch:o}=(t==null?void 0:t.presenter)||{};return{...n,llm:{...n.llm,template:i},script:{...n.script,provider:{...(h=n==null?void 0:n.script)==null?void 0:h.provider,language:r}},stitch:o,...s}}class Fe extends Error{constructor({kind:t,description:s}){const a=JSON.stringify({kind:t,description:s});super(a)}}let L=0;const Ve=45*1e3;function He(e,t,s){var a,n,i,r,o;return{videoType:re(e.presenter.type),output_resolution:(a=t==null?void 0:t.streamOptions)==null?void 0:a.outputResolution,session_timeout:(n=t==null?void 0:t.streamOptions)==null?void 0:n.sessionTimeout,stream_warmup:(i=t==null?void 0:t.streamOptions)==null?void 0:i.streamWarmup,compatibility_mode:(r=t==null?void 0:t.streamOptions)==null?void 0:r.compatibilityMode,stream_greeting:X(e.presenter)!=="clip"&&((o=t==null?void 0:t.streamOptions)!=null&&o.streamGreeting)?s:void 0}}function ue(e){return e===b.Playground?{headers:{[Me]:"true"}}:{}}async function fe(e,t,s,a,n){try{const i=await t.newChat(e,{persist:n??!1},ue(a));return s.track("agent-chat",{event:"created",chat_id:i.id,agent_id:e,mode:a}),i}catch(i){let r;try{r=JSON.parse(i.message)}catch(o){console.error("Error parsing the error message:",o)}throw(r==null?void 0:r.kind)==="InsufficientCreditsError"?new Error("InsufficientCreditsError"):new Error("Cannot create new chat")}}function Ke(e,t,s,a,n,i){return new Promise(async(r,o)=>{var d,C,p,R,w;L=0;const m=String(t.mode);if(!n&&t.mode!==b.DirectPlayback)try{n=await fe(e.id,s,a,t.mode,t.persistentChat)}catch(f){return o(f)}const l=(n==null?void 0:n.chat_mode)||m;if(l!==m&&(t.mode=l,(C=(d=t.callbacks).onModeChange)==null||C.call(d,l),l===b.TextOnly&&((R=(p=t.callbacks)==null?void 0:p.onError)==null||R.call(p,new Fe({kind:"ChatModeDowngraded",description:`Chat mode changed from ${m} to ${l} when creating the chat`}),{}))),l===b.TextOnly)return r({chat:n});const h=await ze(e.id,He(e,t,i),{...t,analytics:a,warmup:(w=t.streamOptions)==null?void 0:w.streamWarmup,callbacks:{...t.callbacks,onConnectionStateChange:async f=>{var E,S,c,g;f===D.Connected?h?((S=(E=t.callbacks).onConnectionStateChange)==null||S.call(E,f),r({chat:n,streamingManager:h})):n&&o(new Error("Something went wrong while initializing the manager")):(g=(c=t.callbacks).onConnectionStateChange)==null||g.call(c,f)},onVideoStateChange(f,E){var S,c;(c=(S=t.callbacks).onVideoStateChange)==null||c.call(S,f),L>0&&(f===j.Start?a.linkTrack("agent-video",{event:"start",latency:Date.now()-L},"start",[K.StreamVideoCreated]):f===j.Stop&&a.linkTrack("agent-video",{event:"stop",is_greenscreen:e.presenter.type==="clip"&&e.presenter.is_greenscreen,background:e.presenter.type==="clip"&&e.presenter.background,...E},"done",[K.StreamVideoDone]))}}}).catch(o)})}function We(e){var s;const t=(s=e.greetings)==null?void 0:s.filter(a=>a.length>0);if(t&&t.length>0){const a=Math.floor(Math.random()*t.length);return t[a]}else return`Hi! I'm ${e.preview_name||"My Agent"}. How can I help you?`}function ge(e,t){return t&&t.length>0?t:[{content:e,id:x(),role:"assistant",created_at:new Date().toISOString()}]}function Ue(e){if(e.answer!==void 0)return e.answer;let t=0,s="";for(;t in e;)s+=e[t],t++;return s}function xe(e,t,s,a,n){if(!(e===B.Partial||e===B.Answer))return;const i=a.messages[a.messages.length-1];if((i==null?void 0:i.role)!=="assistant")return;const{content:r,sequence:o}=t;e===B.Partial?s[o]=r:s.answer=r;const m=Ue(s);(i.content!==m||e===B.Answer)&&(i.content=m,n==null||n([...a.messages],e))}async function qe(e,t){var f,E,S;let s={},a=!0;const n={messages:[],chatMode:t.mode||b.Functional},i=t.baseURL||W,r=t.wsURL||ye,o=t.mixpanelKey||pe,m=de(t.auth,i,t.callbacks.onError),l=await m.getById(e),h=We(l);n.messages=ge(h,t.initialMessages),(E=(f=t.callbacks).onNewMessage)==null||E.call(f,[...n.messages],"answer");const d=Le({token:o,agent:l,isEnabled:t.enableAnalitics,distinctId:t.distinctId});d.track("agent-sdk",{event:"loaded",...Ne(l)});const C={onMessage:(c,g)=>{var k,M;if("content"in g)xe(c,g,s,n,t.callbacks.onNewMessage),c===B.Answer&&d.track("agent-message-received",{messages:n.messages.length,mode:n.chatMode});else{const u=K,y=[u.StreamVideoDone,u.StreamVideoError,u.StreamVideoRejected],_=[u.StreamFailed,u.StreamVideoError,u.StreamVideoRejected],P=Be(g,l,{mode:n.chatMode});if(c=c,c===u.StreamVideoCreated)d.linkTrack("agent-video",P,u.StreamVideoCreated,["start"]);else if(y.includes(c)){const I=c.split("/")[1];_.includes(c)?d.track("agent-video",{...P,event:I}):d.linkTrack("agent-video",{...P,event:I},c,["done"])}_.includes(c)&&((M=(k=t.callbacks).onError)==null||M.call(k,new Error(`Stream failed with event ${c}`),{data:g})),g.event===u.StreamDone&&R()}}};async function p(c){var _,P,I,$,U,N,T;(P=(_=t.callbacks).onConnectionStateChange)==null||P.call(_,D.Connecting),L=0,c&&!a&&(delete n.chat,n.messages=ge(h),($=(I=t.callbacks).onNewMessage)==null||$.call(I,[...n.messages],"answer"));const g=t.mode===b.DirectPlayback?Promise.resolve(void 0):De(t.auth,r,C),k=se(()=>Ke(l,t,m,d,n.chat,c?h:void 0),{limit:3,timeout:Ve,timeoutErrorMessage:"Timeout initializing the stream",shouldRetryFn:A=>(A==null?void 0:A.message)!=="Could not connect"&&A.status!==429,delayMs:1e3}).catch(A=>{var V,H;throw w(b.Maintenance),(H=(V=t.callbacks).onConnectionStateChange)==null||H.call(V,D.Fail),A}),[M,{streamingManager:u,chat:y}]=await Promise.all([g,k]);y&&y.id!==((U=n.chat)==null?void 0:U.id)&&((T=(N=t.callbacks).onNewChat)==null||T.call(N,y.id)),n.streamingManager=u,n.socketManager=M,n.chat=y,a=!1,w((y==null?void 0:y.chat_mode)??t.mode??b.Functional)}async function R(){var c,g,k,M;(c=n.socketManager)==null||c.disconnect(),await((g=n.streamingManager)==null?void 0:g.disconnect()),delete n.streamingManager,delete n.socketManager,(M=(k=t.callbacks).onConnectionStateChange)==null||M.call(k,D.Disconnected)}async function w(c){var g,k;c!==n.chatMode&&(d.track("agent-mode-change",{mode:c}),n.chatMode=c,n.chatMode!==b.Functional&&await R(),(k=(g=t.callbacks).onModeChange)==null||k.call(g,c))}return{agent:l,starterMessages:((S=l.knowledge)==null?void 0:S.starter_message)||[],getSTTToken:()=>m.getSTTToken(l.id),changeMode:w,enrichAnalytics:d.enrich,async connect(){var c;await p(!0),d.track("agent-chat",{event:"connect",chatId:(c=n.chat)==null?void 0:c.id,agentId:l.id,mode:n.chatMode})},async reconnect(){var c;await R(),await p(!1),d.track("agent-chat",{event:"reconnect",chatId:(c=n.chat)==null?void 0:c.id,agentId:l.id,mode:n.chatMode})},async disconnect(){var c;await R(),d.track("agent-chat",{event:"disconnect",chatId:(c=n.chat)==null?void 0:c.id,agentId:l.id,mode:n.chatMode})},async chat(c){var k,M,u,y,_,P;const g=x();s={};try{if(L=Date.now(),t.mode===b.DirectPlayback)throw new Error("Direct playback is enabled, chat is disabled");if(c.length>=800)throw new Error("Message cannot be more than 800 characters");if(c.length===0)throw new Error("Message cannot be empty");if(n.chatMode===b.Maintenance)throw new Error("Chat is in maintenance mode");if(![b.TextOnly,b.Playground].includes(n.chatMode))if(n.streamingManager){if(!n.chat)throw new Error("Chat is not initialized")}else throw new Error("Streaming manager is not initialized");n.messages.push({id:x(),role:"user",content:c,created_at:new Date(L).toISOString()}),(M=(k=t.callbacks).onNewMessage)==null||M.call(k,[...n.messages],"user"),n.chat||(n.chat=await fe(l.id,m,d,n.chatMode,t.persistentChat),(y=(u=t.callbacks).onNewChat)==null||y.call(u,n.chat.id));const I={id:g,role:"assistant",content:"",created_at:new Date().toISOString(),matches:[]},$=[...n.messages];n.messages.push(I);const U=T=>{var A,V;return m.chat(l.id,T,{sessionId:(A=n.streamingManager)==null?void 0:A.sessionId,streamId:(V=n.streamingManager)==null?void 0:V.streamId,chatMode:n.chatMode,messages:$.map(({matches:H,...q})=>q)},{...ue(n.chatMode),skipErrorHandler:!0})},N=await U(n.chat.id).catch(async T=>{var H,q,he,we;const A=(H=T==null?void 0:T.message)==null?void 0:H.includes("missing or invalid session_id");if(!((q=T==null?void 0:T.message)==null?void 0:q.includes("Stream Error"))&&!A)throw(we=(he=t.callbacks).onError)==null||we.call(he,T,{}),T;return await R(),await p(!1),U(n.chat.id)});return d.track("agent-message-send",{event:"success",mode:n.chatMode,messages:n.messages.length+1}),I.context=N.context,I.matches=N.matches,N.result&&(I.content=N.result,d.track("agent-message-received",{latency:Date.now()-L,mode:n.chatMode,messages:n.messages.length}),(P=(_=t.callbacks).onNewMessage)==null||P.call(_,[...n.messages],"answer")),N}catch(I){throw n.messages[n.messages.length-1].id===g&&n.messages.pop(),d.track("agent-message-send",{event:"error",mode:n.chatMode,messages:n.messages.length}),I}},rate(c,g,k){var y,_,P,I;const M=n.messages.find($=>$.id===c);if(n.chat){if(!M)throw new Error("Message not found")}else throw new Error("Chat is not initialized");const u=((y=M.matches)==null?void 0:y.map($=>[$.document_id,$.id]))??[];return d.track("agent-rate",{event:k?"update":"create",thumb:g===1?"up":"down",knowledge_id:((_=l.knowledge)==null?void 0:_.id)??"",mode:n.chatMode,matches:u,score:g}),k?m.updateRating(l.id,n.chat.id,k,{knowledge_id:((P=l.knowledge)==null?void 0:P.id)??"",message_id:c,matches:u,score:g}):m.createRating(l.id,n.chat.id,{knowledge_id:((I=l.knowledge)==null?void 0:I.id)??"",message_id:c,matches:u,score:g})},deleteRate(c){var g;if(!n.chat)throw new Error("Chat is not initialized");return d.track("agent-rate-delete",{type:"text",chat_id:(g=n.chat)==null?void 0:g.id,id:c,mode:n.chatMode}),m.deleteRating(l.id,n.chat.id,c)},speak(c){if(!n.streamingManager)throw new Error("Please connect to the agent first");L=Date.now();function g(){if(typeof c=="string"){if(!l.presenter.voice)throw new Error("Presenter voice is not initialized");return{type:"text",provider:l.presenter.voice,input:c,ssml:!1}}if(c.type==="text"&&!c.provider){if(!l.presenter.voice)throw new Error("Presenter voice is not initialized");return{type:"text",provider:l.presenter.voice,input:c.input,ssml:c.ssml}}return c}const k=g();return d.track("agent-speak",k),n.streamingManager.speak({script:k})}}}function Je(e,t,s){const{getById:a}=de(t,s||W);return a(e)}v.AgentStatus=G,v.ChatMode=b,v.ChatProgress=B,v.ConnectionState=D,v.DocumentType=ne,v.KnowledgeType=te,v.PlanGroup=Z,v.Providers=ae,v.RateState=Q,v.StreamEvents=K,v.StreamingState=j,v.Subject=ee,v.UserPlan=F,v.VideoType=J,v.VoiceAccess=ie,v.createAgentManager=qe,v.getAgent=Je,v.mapVideoType=re,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
